from pyasn1.type import univ

from pkilint import loader
from pkilint.cabf import smime
from pkilint.cabf.smime import smime_constants


def _test_wrapper(pem, expected_validation_level, expected_generation, mapping=None):
    cert = loader.load_pem_certificate(pem.strip(), 'test_cert')

    validation_level, generation = smime.guess_validation_level_and_generation(cert, mapping)

    assert validation_level == expected_validation_level
    assert generation == expected_generation


def test_organization_cn_o_same():
    _test_wrapper("""-----BEGIN CERTIFICATE-----
MIIDvDCCAqSgAwIBAgITDy0lvRE5l0rOQlSHoe49NAaKtDANBgkqhkiG9w0BAQ0F
ADBTMRcwFQYDVQQKEw5Gb28gSW5kdXN0cmllczEkMCIGA1UECxMbRGVwYXJ0bWVu
dCBvZiBDZXJ0aWZpY2F0aW9uMRIwEAYDVQQDEwlSU0EgQ0EgRzMwHhcNMjIxMTIw
MDY1NDE4WhcNMjMxMTI3MDY1NDE3WjAxMQ0wCwYDVQQKEwRJRVRGMREwDwYDVQQL
EwhMQU1QUyBXRzENMAsGA1UEAxMESUVURjCCASIwDQYJKoZIhvcNAQEBBQADggEP
ADCCAQoCggEBAJqVKfqLwaLjj+gBUCfkacKTg8cc2OtJ9ZSed6U3jUoiZVpMLcP3
MUKtLeLg9r1mAfIDlB/wlbdmadXPmrszyidmbuZmOpB5voVQfiLYYy3iOx7YOqzX
rl6udP07k0sV+UdSNRFxrfKeoQEFXgOaGdmnx4OG/e3p1fIKM0dPzZLoOAJF5m5O
0xzXPL74zFCWp2f1ZkuE4A6l41koaZXCN5XL7wWTLMLeNf9Byb5ksKqUuqEHAMd1
nmoNMgjY9VfVfcrv9w43GG8FtpSX+TWzB2zNS2OF+XIVnzRG5DeoULq8v88Z5bLp
IJ/nx26r8A4SSwIBaVv4wPxAf1iPsIVKarUCAwEAAaOBqjCBpzAMBgNVHRMBAf8E
AjAAMBIGA1UdIAQLMAkwBwYFKgMEBQYwHgYDVR0RBBcwFYETYWxpY2VAc21pbWUu
ZXhhbXBsZTATBgNVHSUEDDAKBggrBgEFBQcDBDAOBgNVHQ8BAf8EBAMCBSAwHQYD
VR0OBBYEFKJTQdVEPIApFXwBI/Dnjq/N83cPMB8GA1UdIwQYMBaAFJEwjnwHFwyn
8QkoZTYaZxxodvRZMA0GCSqGSIb3DQEBDQUAA4IBAQCBSXignLEynBakDKU68ro0
RsyXWAPkfXgQLgy7GrW7SrZeBc5IEcjoN9f/gsOx/Ht9Ii6zyBZVjdaox644DsiL
OQEP4YMS7y4q94RFFdmdzEbDLYx9sfUhvdTxDNOOoHz53PYDBh4zE4Nar2inC0D+
VM6RGDy66K9l+D+bl8Wj9CyGUc1ppMNURexTg+z3web/eDOdu+F2MVtluLihne0B
p1GUTkr0mJBolg6dSYal8Hw8/ANHpyExl56BJABb744gqoeuD9YSHjKK49+qYC9f
aFmQ+mK80lh1M9RdNI7srjn0LKpuob6w06jaRzWdNeXzlEc2tUpAr4vRhZjVD6FY
-----END CERTIFICATE-----""", smime_constants.ValidationLevel.ORGANIZATION, smime_constants.Generation.LEGACY)


def test_mapping():
    mapping = {
        univ.ObjectIdentifier('1.2.3.4.5.6'): (smime_constants.ValidationLevel.MAILBOX,
                                               smime_constants.Generation.LEGACY)
    }

    _test_wrapper("""-----BEGIN CERTIFICATE-----
    MIIDvDCCAqSgAwIBAgITDy0lvRE5l0rOQlSHoe49NAaKtDANBgkqhkiG9w0BAQ0F
    ADBTMRcwFQYDVQQKEw5Gb28gSW5kdXN0cmllczEkMCIGA1UECxMbRGVwYXJ0bWVu
    dCBvZiBDZXJ0aWZpY2F0aW9uMRIwEAYDVQQDEwlSU0EgQ0EgRzMwHhcNMjIxMTIw
    MDY1NDE4WhcNMjMxMTI3MDY1NDE3WjAxMQ0wCwYDVQQKEwRJRVRGMREwDwYDVQQL
    EwhMQU1QUyBXRzENMAsGA1UEAxMESUVURjCCASIwDQYJKoZIhvcNAQEBBQADggEP
    ADCCAQoCggEBAJqVKfqLwaLjj+gBUCfkacKTg8cc2OtJ9ZSed6U3jUoiZVpMLcP3
    MUKtLeLg9r1mAfIDlB/wlbdmadXPmrszyidmbuZmOpB5voVQfiLYYy3iOx7YOqzX
    rl6udP07k0sV+UdSNRFxrfKeoQEFXgOaGdmnx4OG/e3p1fIKM0dPzZLoOAJF5m5O
    0xzXPL74zFCWp2f1ZkuE4A6l41koaZXCN5XL7wWTLMLeNf9Byb5ksKqUuqEHAMd1
    nmoNMgjY9VfVfcrv9w43GG8FtpSX+TWzB2zNS2OF+XIVnzRG5DeoULq8v88Z5bLp
    IJ/nx26r8A4SSwIBaVv4wPxAf1iPsIVKarUCAwEAAaOBqjCBpzAMBgNVHRMBAf8E
    AjAAMBIGA1UdIAQLMAkwBwYFKgMEBQYwHgYDVR0RBBcwFYETYWxpY2VAc21pbWUu
    ZXhhbXBsZTATBgNVHSUEDDAKBggrBgEFBQcDBDAOBgNVHQ8BAf8EBAMCBSAwHQYD
    VR0OBBYEFKJTQdVEPIApFXwBI/Dnjq/N83cPMB8GA1UdIwQYMBaAFJEwjnwHFwyn
    8QkoZTYaZxxodvRZMA0GCSqGSIb3DQEBDQUAA4IBAQCBSXignLEynBakDKU68ro0
    RsyXWAPkfXgQLgy7GrW7SrZeBc5IEcjoN9f/gsOx/Ht9Ii6zyBZVjdaox644DsiL
    OQEP4YMS7y4q94RFFdmdzEbDLYx9sfUhvdTxDNOOoHz53PYDBh4zE4Nar2inC0D+
    VM6RGDy66K9l+D+bl8Wj9CyGUc1ppMNURexTg+z3web/eDOdu+F2MVtluLihne0B
    p1GUTkr0mJBolg6dSYal8Hw8/ANHpyExl56BJABb744gqoeuD9YSHjKK49+qYC9f
    aFmQ+mK80lh1M9RdNI7srjn0LKpuob6w06jaRzWdNeXzlEc2tUpAr4vRhZjVD6FY
    -----END CERTIFICATE-----""", smime_constants.ValidationLevel.MAILBOX, smime_constants.Generation.LEGACY, mapping)


def test_guess_with_reserved_oid():
    mapping = {
        univ.ObjectIdentifier('1.2.3.4.5.6'): (smime_constants.ValidationLevel.MAILBOX,
                                               smime_constants.Generation.LEGACY)
    }

    _test_wrapper("""-----BEGIN CERTIFICATE-----
MIIDxzCCAq+gAwIBAgITDy0lvRE5l0rOQlSHoe49NAaKtDANBgkqhkiG9w0BAQ0F
ADBTMRcwFQYDVQQKEw5Gb28gSW5kdXN0cmllczEkMCIGA1UECxMbRGVwYXJ0bWVu
dCBvZiBDZXJ0aWZpY2F0aW9uMRIwEAYDVQQDEwlSU0EgQ0EgRzMwHhcNMjIxMTIw
MDY1NDE4WhcNMjMxMTI3MDY1NDE3WjAxMQ0wCwYDVQQKEwRJRVRGMREwDwYDVQQL
EwhMQU1QUyBXRzENMAsGA1UEAxMESUVURjCCASIwDQYJKoZIhvcNAQEBBQADggEP
ADCCAQoCggEBAJqVKfqLwaLjj+gBUCfkacKTg8cc2OtJ9ZSed6U3jUoiZVpMLcP3
MUKtLeLg9r1mAfIDlB/wlbdmadXPmrszyidmbuZmOpB5voVQfiLYYy3iOx7YOqzX
rl6udP07k0sV+UdSNRFxrfKeoQEFXgOaGdmnx4OG/e3p1fIKM0dPzZLoOAJF5m5O
0xzXPL74zFCWp2f1ZkuE4A6l41koaZXCN5XL7wWTLMLeNf9Byb5ksKqUuqEHAMd1
nmoNMgjY9VfVfcrv9w43GG8FtpSX+TWzB2zNS2OF+XIVnzRG5DeoULq8v88Z5bLp
IJ/nx26r8A4SSwIBaVv4wPxAf1iPsIVKarUCAwEAAaOBtTCBsjAMBgNVHRMBAf8E
AjAAMB0GA1UdIAQWMBQwBwYFKgMEBQYwCQYHZ4EMAQUCAjAeBgNVHREEFzAVgRNh
bGljZUBzbWltZS5leGFtcGxlMBMGA1UdJQQMMAoGCCsGAQUFBwMEMA4GA1UdDwEB
/wQEAwIFIDAdBgNVHQ4EFgQUolNB1UQ8gCkVfAEj8OeOr83zdw8wHwYDVR0jBBgw
FoAUkTCOfAcXDKfxCShlNhpnHGh29FkwDQYJKoZIhvcNAQENBQADggEBAIFJeKCc
sTKcFqQMpTryujRGzJdYA+R9eBAuDLsatbtKtl4FzkgRyOg31/+Cw7H8e30iLrPI
FlWN1qjHrjgOyIs5AQ/hgxLvLir3hEUV2Z3MRsMtjH2x9SG91PEM046gfPnc9gMG
HjMTg1qvaKcLQP5UzpEYPLror2X4P5uXxaP0LIZRzWmkw1RF7FOD7PfB5v94M527
4XYxW2W4uKGd7QGnUZROSvSYkGiWDp1JhqXwfDz8A0enITGXnoEkAFvvjiCqh64P
1hIeMorj36pgL19oWZD6YrzSWHUz1F00juyuOfQsqm6hvrDTqNpHNZ015fOURza1
SkCvi9GFmNUPoVg=
-----END CERTIFICATE-----""", smime_constants.ValidationLevel.ORGANIZATION, smime_constants.Generation.MULTIPURPOSE,
                  mapping)


def test_sponsored_cn_o_different():
    _test_wrapper("""-----BEGIN CERTIFICATE-----
MIIDzzCCAregAwIBAgITDy0lvRE5l0rOQlSHoe49NAaKtDANBgkqhkiG9w0BAQ0F
ADBTMRcwFQYDVQQKEw5Gb28gSW5kdXN0cmllczEkMCIGA1UECxMbRGVwYXJ0bWVu
dCBvZiBDZXJ0aWZpY2F0aW9uMRIwEAYDVQQDEwlSU0EgQ0EgRzMwHhcNMjIxMTIw
MDY1NDE4WhcNMjMxMTI3MDY1NDE3WjBEMQ0wCwYDVQQKEwRJRVRGMREwDwYDVQQL
EwhMQU1QUyBXRzEgMB4GA1UEAxMXSUVURiBEb2N1bWVudCBFbmNyeXB0b3IwggEi
MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCalSn6i8Gi44/oAVAn5GnCk4PH
HNjrSfWUnnelN41KImVaTC3D9zFCrS3i4Pa9ZgHyA5Qf8JW3ZmnVz5q7M8onZm7m
ZjqQeb6FUH4i2GMt4jse2Dqs165ernT9O5NLFflHUjURca3ynqEBBV4DmhnZp8eD
hv3t6dXyCjNHT82S6DgCReZuTtMc1zy++MxQlqdn9WZLhOAOpeNZKGmVwjeVy+8F
kyzC3jX/Qcm+ZLCqlLqhBwDHdZ5qDTII2PVX1X3K7/cONxhvBbaUl/k1swdszUtj
hflyFZ80RuQ3qFC6vL/PGeWy6SCf58duq/AOEksCAWlb+MD8QH9Yj7CFSmq1AgMB
AAGjgaowgacwDAYDVR0TAQH/BAIwADASBgNVHSAECzAJMAcGBSoDBAUGMB4GA1Ud
EQQXMBWBE2FsaWNlQHNtaW1lLmV4YW1wbGUwEwYDVR0lBAwwCgYIKwYBBQUHAwQw
DgYDVR0PAQH/BAQDAgUgMB0GA1UdDgQWBBSiU0HVRDyAKRV8ASPw546vzfN3DzAf
BgNVHSMEGDAWgBSRMI58BxcMp/EJKGU2GmccaHb0WTANBgkqhkiG9w0BAQ0FAAOC
AQEAgUl4oJyxMpwWpAylOvK6NEbMl1gD5H14EC4Muxq1u0q2XgXOSBHI6DfX/4LD
sfx7fSIus8gWVY3WqMeuOA7IizkBD+GDEu8uKveERRXZncxGwy2MfbH1Ib3U8QzT
jqB8+dz2AwYeMxODWq9opwtA/lTOkRg8uuivZfg/m5fFo/QshlHNaaTDVEXsU4Ps
98Hm/3gznbvhdjFbZbi4oZ3tAadRlE5K9JiQaJYOnUmGpfB8PPwDR6chMZeegSQA
W++OIKqHrg/WEh4yiuPfqmAvX2hZkPpivNJYdTPUXTSO7K459CyqbqG+sNOo2kc1
nTXl85RHNrVKQK+L0YWY1Q+hWA==
-----END CERTIFICATE-----""", smime_constants.ValidationLevel.SPONSORED, smime_constants.Generation.LEGACY)


def test_mailbox_empty_subject_dn():
    _test_wrapper("""-----BEGIN CERTIFICATE-----
MIIDizCCAnOgAwIBAgITDy0lvRE5l0rOQlSHoe49NAaKtDANBgkqhkiG9w0BAQ0F
ADBTMRcwFQYDVQQKEw5Gb28gSW5kdXN0cmllczEkMCIGA1UECxMbRGVwYXJ0bWVu
dCBvZiBDZXJ0aWZpY2F0aW9uMRIwEAYDVQQDEwlSU0EgQ0EgRzMwHhcNMjIxMTIw
MDY1NDE4WhcNMjMxMTI3MDY1NDE3WjAAMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A
MIIBCgKCAQEAmpUp+ovBouOP6AFQJ+RpwpODxxzY60n1lJ53pTeNSiJlWkwtw/cx
Qq0t4uD2vWYB8gOUH/CVt2Zp1c+auzPKJ2Zu5mY6kHm+hVB+IthjLeI7Htg6rNeu
Xq50/TuTSxX5R1I1EXGt8p6hAQVeA5oZ2afHg4b97enV8gozR0/Nkug4AkXmbk7T
HNc8vvjMUJanZ/VmS4TgDqXjWShplcI3lcvvBZMswt41/0HJvmSwqpS6oQcAx3We
ag0yCNj1V9V9yu/3DjcYbwW2lJf5NbMHbM1LY4X5chWfNEbkN6hQury/zxnlsukg
n+fHbqvwDhJLAgFpW/jA/EB/WI+whUpqtQIDAQABo4GqMIGnMAwGA1UdEwEB/wQC
MAAwEgYDVR0gBAswCTAHBgUqAwQFBjAeBgNVHREEFzAVgRNhbGljZUBzbWltZS5l
eGFtcGxlMBMGA1UdJQQMMAoGCCsGAQUFBwMEMA4GA1UdDwEB/wQEAwIFIDAdBgNV
HQ4EFgQUolNB1UQ8gCkVfAEj8OeOr83zdw8wHwYDVR0jBBgwFoAUkTCOfAcXDKfx
CShlNhpnHGh29FkwDQYJKoZIhvcNAQENBQADggEBAIFJeKCcsTKcFqQMpTryujRG
zJdYA+R9eBAuDLsatbtKtl4FzkgRyOg31/+Cw7H8e30iLrPIFlWN1qjHrjgOyIs5
AQ/hgxLvLir3hEUV2Z3MRsMtjH2x9SG91PEM046gfPnc9gMGHjMTg1qvaKcLQP5U
zpEYPLror2X4P5uXxaP0LIZRzWmkw1RF7FOD7PfB5v94M5274XYxW2W4uKGd7QGn
UZROSvSYkGiWDp1JhqXwfDz8A0enITGXnoEkAFvvjiCqh64P1hIeMorj36pgL19o
WZD6YrzSWHUz1F00juyuOfQsqm6hvrDTqNpHNZ015fOURza1SkCvi9GFmNUPoVg=
-----END CERTIFICATE-----""", smime_constants.ValidationLevel.MAILBOX, smime_constants.Generation.LEGACY)


def test_individual_givenname():
    _test_wrapper("""-----BEGIN CERTIFICATE-----
MIIDmTCCAoGgAwIBAgITDy0lvRE5l0rOQlSHoe49NAaKtDANBgkqhkiG9w0BAQ0F
ADBTMRcwFQYDVQQKEw5Gb28gSW5kdXN0cmllczEkMCIGA1UECxMbRGVwYXJ0bWVu
dCBvZiBDZXJ0aWZpY2F0aW9uMRIwEAYDVQQDEwlSU0EgQ0EgRzMwHhcNMjIxMTIw
MDY1NDE4WhcNMjMxMTI3MDY1NDE3WjAOMQwwCgYDVQQqEwNCb2IwggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQCalSn6i8Gi44/oAVAn5GnCk4PHHNjrSfWU
nnelN41KImVaTC3D9zFCrS3i4Pa9ZgHyA5Qf8JW3ZmnVz5q7M8onZm7mZjqQeb6F
UH4i2GMt4jse2Dqs165ernT9O5NLFflHUjURca3ynqEBBV4DmhnZp8eDhv3t6dXy
CjNHT82S6DgCReZuTtMc1zy++MxQlqdn9WZLhOAOpeNZKGmVwjeVy+8FkyzC3jX/
Qcm+ZLCqlLqhBwDHdZ5qDTII2PVX1X3K7/cONxhvBbaUl/k1swdszUtjhflyFZ80
RuQ3qFC6vL/PGeWy6SCf58duq/AOEksCAWlb+MD8QH9Yj7CFSmq1AgMBAAGjgaow
gacwDAYDVR0TAQH/BAIwADASBgNVHSAECzAJMAcGBSoDBAUGMB4GA1UdEQQXMBWB
E2FsaWNlQHNtaW1lLmV4YW1wbGUwEwYDVR0lBAwwCgYIKwYBBQUHAwQwDgYDVR0P
AQH/BAQDAgUgMB0GA1UdDgQWBBSiU0HVRDyAKRV8ASPw546vzfN3DzAfBgNVHSME
GDAWgBSRMI58BxcMp/EJKGU2GmccaHb0WTANBgkqhkiG9w0BAQ0FAAOCAQEAgUl4
oJyxMpwWpAylOvK6NEbMl1gD5H14EC4Muxq1u0q2XgXOSBHI6DfX/4LDsfx7fSIu
s8gWVY3WqMeuOA7IizkBD+GDEu8uKveERRXZncxGwy2MfbH1Ib3U8QzTjqB8+dz2
AwYeMxODWq9opwtA/lTOkRg8uuivZfg/m5fFo/QshlHNaaTDVEXsU4Ps98Hm/3gz
nbvhdjFbZbi4oZ3tAadRlE5K9JiQaJYOnUmGpfB8PPwDR6chMZeegSQAW++OIKqH
rg/WEh4yiuPfqmAvX2hZkPpivNJYdTPUXTSO7K459CyqbqG+sNOo2kc1nTXl85RH
NrVKQK+L0YWY1Q+hWA==
-----END CERTIFICATE-----""", smime_constants.ValidationLevel.INDIVIDUAL, smime_constants.Generation.LEGACY)
